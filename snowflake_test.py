from secret_client import SecretClient
from snowflake_bi_client import SnowflakeBIGetter
from pympler import asizeof
from time import perf_counter

MAX_QUERY = "'102878','131592','131618','150050','197631','206920','289335','177819','151160','320545','46835','51502','51505','54277','61978','65518','67535','237945','76138','103416','46806','57618','139700','151476','77106','184947','794758','101942','85699','124885','85742','86218','86899','90246','51246','47982','131319','91473','918638','140149','100004','112005','133404','139400','1000053947','186743','205280','134746','206108','213575','221372','227756','229101','103465','230649','244865','232464','267721','223752','267800','103519','285480','301274','305823','264135','322028','322817','288953','334617','193160','328115','340068','350489','148798','355925','356311','169582','135172','47963','173981','326998','203723','286485','219571','204052','152126','282023','241486','271474','340523','283574','577558','284142','192292','131220','288012','278723','196993','281679','212790','281639','361641','337930','264359','214257','323768','210011','230561','289411','123146','354571','141816','156436','252080','328305','60012','205455','625174','309526','642494','197952','648694','324040','186181','69301','71084','351902','72349','310535','191918','257304','609086','137963','353172','697038','65899','360921','179521','356717','183229','47053','744630','148326','264440','298320','194688','1000044316','121710','322320','327915','295210','174582','65939','76803','201820','133094','781326','149252','1000027342','74592','223556','217278','369256','1000001582','142680','370674','104424','207297','361315','79148','179237','143980','59159','108017','127452','197822','142581','74576','1000031494','63664','250747','516190','242490','290473','121756','250717','677046','193646','815102','125728','605918','50808','339833','83015','80504','838878','84557','267949','129180','61222','215432','253362','370223','851926','150045','243312','100774','198045','111475','190450','574142','148684','298178','136379','159275','346116','299449','369241','202043','277517','131482','263585','103652','287163','324105','208564','160598','717990','123995','280188','318825','318018','191194','319701','131721','362714','70594','79904','344679','117112','134632','657854','114010','115178','280412','872934','271937','202085','340945','372850','211391','316133','201198','285989','154397','137756','355026','158160','208191','56217','337547','232239','302912','158779','48629','141371','354359','368372','225413','294123','262061','178346','839454','308198','176155','80139','324602','253658','248551','803918','347892','217999','873502','189843','369218','110645','345777','187580','158551','350728','219302','282247','228508','288313','293294','180314','756542','250278','153130','87580','570022','287880','859510','65481','87996','195484','626702','67051','253760','337198','100163','88399','119154','286117','881390','355758','150599','290082','294898','229533','57786','343586','288236','1000010534','577334','119378','626182','269013','365951','510334','169692','88611','151917','541998','575878','156004','46846','293384','126448','101627','1000017078','203875','640982','84255','195971','327737','515918','151334','206453','161315','127847','63120','132119','367702','666334','509950','114707','366895','354062','365496','182526','240403','362433','284254','319659','305219','341318','239419','506526','50704','198613','63124','254593','265025','294368','1000031478','222747','339296','109788','352266','52566','371846','321824','300067','47782','284419','1000041396','364366','294988','664790','1000009638','172433','189095','121122','269883','256781','162713','249090','191810','891110','173720','164414','795126','362193','243056','352868','647430','210854','89250','337555','84952','324056','71961','330297','836310','137382','734910','60473','307604','211673','254644','123392','188521','214333','710166','1000042652','735118','133190','212483','103934','219212','113483','249032','350562','679942','324112','210464','229776','340579','236643','254204','662294','351080','793558','192323','283515','239142','161997','798686','698302','90487','74104','1000032478','316806','370886','319254','640998','315128','250196','54111','296443','346110','280162','302632','266365','342783','79623','335277','164093','288531','282233','342753','562262','332129','120543','362651','140042','139195','349775','264529','113868','363393','665774','222451','105563','363403','321715','112021','334597','890774','353710','238095','649206','182611','293900','311532','255012','134834','225554','916390'"
# MAX_QUERY = "'158995','146412','146204','259361','146409','224821','224819','146142','146391','146066','224823','146411','146406','146676','146387','146101','146573','146389','146203','146068','146062','224909','152704','160909','224817','158998','146408','146405','270941','146097','146403','146570','146785','146140','146064','146438','146446','959638','851790','899766','158997','146870','146138','146421','158994','146286','146574','899798','146420','146099','899702','146685','146134','146569','152702','146171','146647','146436','146133','146070','899734','146280','160908','162920','146934','146675','146167','146684','899758','258440','152703','641662','146749','174352','899694','270944','146550','214560','270939','216792','641670','146173','270940','146224','146422','146076','146850','146132','146442','146760','146434','146283','146648','146764','976566','146761','296041','146296','146103','149562','194503','216791','146320','899790','146869','233486','146318','146060','146572','546734','146264','146169','165087','270945','148550','146568','959630','146256','233484','270943','899726','164733','313146','352762','146265','258439','267320','146202','151584','148548','146758','152440','177794','151585','146743','146872','313145','146165','146444','301411','146935','146649','146678','146762','146854','296040','146423','146868','146046','146226','146763','146532','186173','146285','313144','146933','146247','313167','146703','943150','146129','146148','146316','622422','146225','146136','146238','146613','146243','146106','959622','146402','146279','266358','146890','296039','146282','146301','146757','146781','146244','146741','851782','146432','146289','976550','179734','146735','146752','146277','146811','179645','258438','352784','146056','179602','158990','146542','146312','146458','177790','146856','146150','146146','266356','146111','146249','146462','146864','146114','146241','164731','146926','178017','146121','224815','266357','270942','146910','146838','146393','146255','976342','227434','146094','146951','233485','146263','254935','146556','146048','146753','703782','146250','148546','311106','146545','153677','146782','254939','146662','205215','146110','146645','313177','146415','310496','146105','146397','146525','146310','227432','214562','151583','146759','146543','213427','146354','246808','546670','254937','205218','177798','246800','616646','146338','942766','164732','290529','146750','976558','146115','154864','843526','82584','146718','146109','146512','146717','146936','259243','242991','146331','266355','146398','641694','146240','146314','146612','169029','179646','164734','786150','146052','146790','146687','146577','50460','146541','146878','157190','146950','899686','942990','178054','146895','146589','899750','205253','181780','146152','146119','105064','310491','69857','146853','311104','146123','146356','81328','174079','546686','259245','49989','246810','146855','216793','616638','50317','146073','976574','80487','146840','246126','61822','247909','146221','273274','47183','69765','146130','146246','146128','89568','146930','146755','146267','146745','57599','146527','146050','157331','158216','146766','899670','146671','146091','127908','146220','69864','641678','92810','146780','89368','146817','146949','177817','67033','146460','246238','176632','352766','146216','152884','851774','146686','175421','49984','146288','179641','254933','193239','69761','98670','899782','49987','179732','161807','76096','89735','69817','78095','146806','290527','194504','316648','265536','102212','320529','259363','178062','146797','801782','214730','243005','354294','321911','146322','47185','299280','703622','69771','67019','146846','159278','102991','246903','146754','78033','157668','146113','216790','899718','156396','78108','69806','80489','104893','46674','311105','69865','157665','102205','146737','157715','113555','65072','146876','49535','864198','146833','150454','151548','75918','157347','81309','81605','50343','146721','64874','82586','100469','146795','146732','139638','146837','76047','140299','69848','146269','94014','141273','141397','184400','49953','150452','146880','146551','80485','148853','69796','69844','159280','73563','146667','146650','261492','146580','146276','99652','246121','213075','205219','256275','51016','90655','146654','69863','64893','87466','46918','146736','146305','94201','146611','48856','146329','146813','146576','89777'"

sql3 = """
with freq as (SELECT mps.product_part_number AS "Product Part Number", COUNT(*) 
FROM mrch.merch_performance_snapshot_pharmacy mps
LEFT JOIN chewybi.common_date cd ON cd.common_date_dttm = mps.activity_date
WHERE mps.activity_date BETWEEN '2023-10-02' AND '2024-10-01'
GROUP BY mps.product_part_number
ORDER BY COUNT(*) DESC
LIMIT 500)

SELECT "Product Part Number"
FROM freq;
        """


if __name__ == "__main__":
    secret_client = SecretClient()
    tic = perf_counter()
    with SnowflakeBIGetter(secret_client) as bi_getter:
        with open("queries/map_msrp_query.sql", "r") as f:
            map_query = f.read()
            map_query = map_query.format(MAX_QUERY)
            print(map_query)
            print("=================")
            pass
        res = bi_getter.execute_query(map_query)
    toc = perf_counter()
    # print("map_query:", res)
    # print("top 500 skus:", [x[0] for x in res])
    # print("type map_query:", type(res))
    print("time taken (seconds):", toc - tic)
    print("sizeof map_query(MB):", asizeof.asizeof(res) / 2**20)
